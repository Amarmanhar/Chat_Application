<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../public/home.css">
    <script
    src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"
    integrity="sha512-uMtXmF28A2Ab/JJO2t/vYhlaa/3ahUOgj1Zf27M5rOo8/+fcTUVH0/E0ll68njmjrLqOBjXM3V9NiPFL5ywWPQ=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  ></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <title>home page</title>
    
</head>
<body>
    <div class="container">
       
        <div class="leftSide">
             <!--  header section-->
           <div class="header">
                  
           </div>
             <!--chat list-->
             <div class="chatList">
              
             </div>
        </div>

        <div class="rightSide">
            <div class="header">
                <h4 id="loggedInUserName">You joined</h4>
            </div>
          
            <!-- chat box -->
            <div class="chatBox">
                <div class="user-list">
                    <!-- Active users will be displayed here -->
                  </div>
                <div class="message my_message">
                   
                </div>
                <div class="message frnd_message">
                    
                </div>
            </div>

               <!-- footer section -->
            <div class="chatBox_input">
                <input id="chat-message" type="text" placeholder="type a message">
               <ion-icon id="sendBtn" name="send-outline"></ion-icon>
            </div>
        </div>
    </div>
    
    <script>
           
         async function updateActiveUsers() {
    
        const response = await axios.get('http://localhost:5000/add/get/active-users');
        const activeUsersList = response.data;

        // Find the elements for displaying the recently joined and previously joined users
        const loggedInUserName = document.getElementById('loggedInUserName');
        const userlistContainer = document.querySelector('.user-list');

        // Clear the user list
        userlistContainer.innerHTML = '';

        // Separate the recently joined and previously joined users
        const recentlyJoinedUsers = activeUsersList.slice(0, 1); // Assuming the first user is the most recent
        const previouslyJoinedUsers = activeUsersList.slice(0,-1); // The rest are previously joined

        // Display the most recently joined user in the header
        loggedInUserName.innerHTML = `welcome: ${activeUsersList[activeUsersList.length - 1]}`;

        // Display the previously joined users below the header
        previouslyJoinedUsers.forEach((user) => {
            const userItem = document.createElement('div');
            userItem.innerHTML =`<div>${user} :- joined</div>`;
            userlistContainer.appendChild(userItem);
        });
    } 
    // setInterval(updateActiveUsers, 10000); 
    updateActiveUsers();

            const sendBtn = document.querySelector('#sendBtn');
            sendBtn.addEventListener('click', async(event)=>{

                 const message = document.querySelector('#chat-message').value;
                 const token = localStorage.getItem('token');
                 
                 const response = await axios.post('http://localhost:5000/post-chat/chat',{message},{headers:{"Authorization": token}});

                 console.log(response.data);
            })

          // Define a function to fetch and update messages
            async function fetchAndUpdateMessages() {
                const lastMsgId = localStorage.getItem('lastMessageId') || 0;
                const response = await axios.get(`http://localhost:5000/post-chat/get-chats/${lastMsgId}`);
                const newMessages = response.data;
                console.log(newMessages);

                if (newMessages.length > 0) {
                    const latestMessageId = newMessages[newMessages.length - 1].id;
                    localStorage.setItem('lastMessageId', latestMessageId);
                }

                // Update local storage with only new messages
                let oldMessages = JSON.parse(localStorage.getItem('messages')) || [];
                oldMessages = oldMessages.slice(-9); // Keep the last 9 messages, remove the older ones
                const updatedMessages = [...oldMessages, ...newMessages];
                localStorage.setItem('messages', JSON.stringify(updatedMessages));

                // Display the messages
                getMessages(updatedMessages);
            }
            fetchAndUpdateMessages();
            setInterval(fetchAndUpdateMessages, 1000);


            async function getMessages(messages) {
            try {
                   
                    const messageContainer = document.querySelector('.frnd_message');
                    messageContainer.innerHTML = '';
                    messages.forEach((message) => {
                        const frndMessageDiv = document.createElement('div');
                        frndMessageDiv.classList.add('frnd_message');

                       const messageItem = document.createElement('p');
                       
                       if (message.user && message.user.name) {
                        messageItem.innerHTML = `
                       <h4>${message.user.name}</h4>
                        <p>${message.message}</p>
                        `;
                       
                    } 
                    frndMessageDiv.appendChild(messageItem);
                    // Append the frndMessageDiv to the messageContainer
                    messageContainer.appendChild(frndMessageDiv); 
                });
               } catch (err) {
                   console.error('Error fetching messages:', err);
                }
         }


    </script>
</body>
</html>
